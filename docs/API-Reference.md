# Chorus Bridge - API Reference

## üìö **API Overview**

The Chorus Bridge provides a comprehensive REST API for federation, monitoring, and management operations. This document provides complete API reference with examples and detailed specifications.

## üîó **Base URL**

```
Production: https://bridge.chorus.network
Development: http://localhost:8000
```

## üîê **Authentication**

### **JWT Authentication**

All API endpoints require JWT authentication using the `Authorization` header:

```http
Authorization: Bearer <jwt_token>
```

### **JWT Token Structure**

```json
{
  "sub": "stage_instance_id",
  "iat": 1640995200,
  "exp": 1640998800,
  "jti": "unique_token_id"
}
```

### **Token Generation**

JWT tokens are signed using Ed25519 keys and must be generated by authorized Stage instances.

## üì° **API Endpoints**

### **Federation Endpoints**

#### **POST /api/bridge/federation/send**

Sends a federation envelope to the bridge for processing.

**Headers:**
```http
X-Chorus-Instance-Id: <stage_instance_id>
Idempotency-Key: <unique_key>
Authorization: Bearer <jwt_token>
Content-Type: application/octet-stream
```

**Request Body:**
- **Content-Type:** `application/octet-stream`
- **Body:** Serialized `FederationEnvelope` protobuf message

**Response:**
```json
{
  "status": "accepted",
  "event_id": "event_12345",
  "timestamp": 1640995200
}
```

**Status Codes:**
- `202 Accepted` - Envelope accepted for processing
- `400 Bad Request` - Invalid envelope or missing headers
- `401 Unauthorized` - Invalid or missing JWT token
- `409 Conflict` - Duplicate envelope or idempotency key
- `429 Too Many Requests` - Rate limit exceeded

**Example:**
```bash
curl -X POST "https://bridge.chorus.network/api/bridge/federation/send" \
  -H "X-Chorus-Instance-Id: stage-001" \
  -H "Idempotency-Key: unique-key-123" \
  -H "Authorization: Bearer <jwt_token>" \
  -H "Content-Type: application/octet-stream" \
  --data-binary @envelope.bin
```

#### **GET /api/bridge/day-proof/{day_number}**

Retrieves a day proof for the specified day number.

**Parameters:**
- `day_number` (path, required): The day number for which to retrieve the proof

**Response:**
```json
{
  "day_number": 12345,
  "proof": "canonical_proof_hash",
  "proof_hash": "sha256_hash",
  "canonical": true,
  "source": "conductor"
}
```

**Status Codes:**
- `200 OK` - Day proof retrieved successfully
- `404 Not Found` - Day proof not available
- `500 Internal Server Error` - Server error

**Example:**
```bash
curl -X GET "https://bridge.chorus.network/api/bridge/day-proof/12345" \
  -H "Authorization: Bearer <jwt_token>"
```

#### **POST /api/bridge/activitypub/export**

Exports a Chorus post to ActivityPub format.

**Headers:**
```http
X-Chorus-Instance-Id: <stage_instance_id>
Authorization: Bearer <jwt_token>
Content-Type: application/json
```

**Request Body:**
```json
{
  "chorus_post": {
    "post_id": "post_12345",
    "author_pubkey": "author_public_key",
    "content": "Post content",
    "creation_day": 12345
  },
  "target_instances": ["instance1", "instance2"]
}
```

**Response:**
```json
{
  "job_id": "export_job_12345",
  "status": "queued",
  "estimated_completion": 1640995800
}
```

**Status Codes:**
- `202 Accepted` - Export job queued
- `400 Bad Request` - Invalid request data
- `401 Unauthorized` - Invalid authentication
- `422 Unprocessable Entity` - Validation error

**Example:**
```bash
curl -X POST "https://bridge.chorus.network/api/bridge/activitypub/export" \
  -H "X-Chorus-Instance-Id: stage-001" \
  -H "Authorization: Bearer <jwt_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "chorus_post": {
      "post_id": "post_12345",
      "author_pubkey": "author_key",
      "content": "Hello Chorus!",
      "creation_day": 12345
    },
    "target_instances": ["stage-002", "stage-003"]
  }'
```

#### **POST /api/bridge/moderation/event**

Records a moderation event.

**Headers:**
```http
X-Chorus-Instance-Id: <stage_instance_id>
Authorization: Bearer <jwt_token>
Content-Type: application/json
```

**Request Body:**
```json
{
  "target_ref": "target_reference",
  "action": "remove",
  "reason_hash": "reason_hash",
  "creation_day": 12345
}
```

**Response:**
```json
{
  "event_id": "moderation_event_12345",
  "status": "recorded",
  "timestamp": 1640995200
}
```

**Status Codes:**
- `201 Created` - Moderation event recorded
- `400 Bad Request` - Invalid event data
- `401 Unauthorized` - Invalid authentication
- `422 Unprocessable Entity` - Validation error

**Example:**
```bash
curl -X POST "https://bridge.chorus.network/api/bridge/moderation/event" \
  -H "X-Chorus-Instance-Id: stage-001" \
  -H "Authorization: Bearer <jwt_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "target_ref": "post_12345",
    "action": "remove",
    "reason_hash": "spam_violation",
    "creation_day": 12345
  }'
```

### **Health Check Endpoints**

#### **GET /health**

Basic health check endpoint.

**Response:**
```json
{
  "status": "healthy",
  "timestamp": 1640995200,
  "version": "0.2.0"
}
```

**Status Codes:**
- `200 OK` - Service is healthy
- `503 Service Unavailable` - Service is unhealthy

#### **GET /health/ready**

Readiness check for Kubernetes.

**Response:**
```json
{
  "status": "ready",
  "checks": {
    "database": "ok",
    "conductor": "ok",
    "trust_store": "ok"
  }
}
```

**Status Codes:**
- `200 OK` - Service is ready
- `503 Service Unavailable` - Service is not ready

#### **GET /health/live**

Liveness check for Kubernetes.

**Response:**
```json
{
  "status": "alive",
  "uptime": 3600,
  "memory_usage": "45%"
}
```

**Status Codes:**
- `200 OK` - Service is alive
- `503 Service Unavailable` - Service is not alive

### **Metrics Endpoints**

#### **GET /metrics**

Prometheus metrics endpoint.

**Response:**
```
# HELP bridge_events_received_total Total number of federation events received
# TYPE bridge_events_received_total counter
bridge_events_received_total 1234

# HELP bridge_events_processed_total Total number of federation events processed
# TYPE bridge_events_processed_total counter
bridge_events_processed_total{message_type="PostAnnouncement"} 567

# HELP bridge_conductor_requests_total Total number of requests to conductor
# TYPE bridge_conductor_requests_total counter
bridge_conductor_requests_total{method="GetDayProof",status="success"} 89
```

## üîí **Rate Limiting**

### **Rate Limit Headers**

All API responses include rate limiting headers:

```http
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1640995800
```

### **Rate Limit Policies**

| Endpoint | Limit | Window | Burst |
|----------|-------|--------|-------|
| `/federation/send` | 10 req/s | 1 minute | 50 |
| `/day-proof/*` | 5 req/s | 1 minute | 20 |
| `/activitypub/export` | 2 req/s | 1 minute | 10 |
| `/moderation/event` | 5 req/s | 1 minute | 25 |

### **Rate Limit Exceeded**

When rate limits are exceeded:

**Response:**
```json
{
  "error": "rate_limit_exceeded",
  "message": "Rate limit exceeded. Try again later.",
  "retry_after": 60
}
```

**Status Code:** `429 Too Many Requests`

## üõ°Ô∏è **Security**

### **Request Signing**

All federation requests must be signed using Ed25519:

```python
import nacl.signing
import nacl.encoding

# Sign the message
signing_key = nacl.signing.SigningKey.from_seed(seed)
signed_message = signing_key.sign(message_data)
signature = signed_message.signature
```

### **Signature Verification**

The bridge verifies all incoming signatures:

1. **Extract signature** from the federation envelope
2. **Retrieve public key** from trust store
3. **Verify signature** using Ed25519
4. **Reject if invalid** or from unknown instance

### **Trust Store Management**

The bridge maintains a trust store of known instances:

```json
{
  "stage-001": "ed25519_public_key_1",
  "stage-002": "ed25519_public_key_2",
  "stage-003": "ed25519_public_key_3"
}
```

## üìä **Error Handling**

### **Error Response Format**

All errors follow a consistent format:

```json
{
  "error": "error_code",
  "message": "Human-readable error message",
  "details": {
    "field": "specific_field_error"
  },
  "timestamp": 1640995200,
  "request_id": "req_12345"
}
```

### **Common Error Codes**

| Code | Description | Status |
|------|-------------|--------|
| `invalid_envelope` | Malformed federation envelope | 400 |
| `signature_verification_failed` | Invalid message signature | 401 |
| `unknown_instance` | Instance not in trust store | 401 |
| `duplicate_envelope` | Envelope already processed | 409 |
| `duplicate_idempotency_key` | Idempotency key already used | 409 |
| `rate_limit_exceeded` | Too many requests | 429 |
| `conductor_unavailable` | Conductor network unavailable | 503 |

### **Validation Errors**

For validation errors, the `details` field contains specific field errors:

```json
{
  "error": "validation_error",
  "message": "Request validation failed",
  "details": {
    "chorus_post.post_id": "Field is required",
    "target_instances": "Must be a non-empty array"
  }
}
```

## üîÑ **Webhooks (Future)**

### **Webhook Endpoints**

Webhooks will be available for real-time notifications:

```
POST /webhooks/federation/processed
POST /webhooks/activitypub/exported
POST /webhooks/moderation/recorded
```

### **Webhook Payload**

```json
{
  "event_type": "federation.processed",
  "timestamp": 1640995200,
  "data": {
    "envelope_id": "env_12345",
    "sender_instance": "stage-001",
    "message_type": "PostAnnouncement"
  }
}
```

## üìù **SDK Examples**

### **Python SDK**

```python
from chorus_bridge import BridgeClient

# Initialize client
client = BridgeClient(
    base_url="https://bridge.chorus.network",
    jwt_token="your_jwt_token"
)

# Send federation envelope
response = client.send_federation_envelope(
    envelope_data=envelope_bytes,
    stage_instance="stage-001",
    idempotency_key="unique_key"
)

# Get day proof
day_proof = client.get_day_proof(day_number=12345)

# Export to ActivityPub
job = client.export_to_activitypub(
    chorus_post=post_data,
    target_instances=["stage-002", "stage-003"]
)
```

### **JavaScript SDK**

```javascript
import { BridgeClient } from '@chorus/bridge-client';

// Initialize client
const client = new BridgeClient({
  baseUrl: 'https://bridge.chorus.network',
  jwtToken: 'your_jwt_token'
});

// Send federation envelope
const response = await client.sendFederationEnvelope({
  envelopeData: envelopeBytes,
  stageInstance: 'stage-001',
  idempotencyKey: 'unique_key'
});

// Get day proof
const dayProof = await client.getDayProof(12345);

// Export to ActivityPub
const job = await client.exportToActivityPub({
  chorusPost: postData,
  targetInstances: ['stage-002', 'stage-003']
});
```

## üß™ **Testing**

### **Test Environment**

Use the test environment for development and testing:

```
Base URL: https://test-bridge.chorus.network
```

### **Test Data**

Test instances and keys are available for development:

```json
{
  "test_stage_001": "test_ed25519_key_1",
  "test_stage_002": "test_ed25519_key_2"
}
```

### **Integration Tests**

Example integration test:

```python
import pytest
from chorus_bridge import BridgeClient

def test_federation_envelope_processing():
    client = BridgeClient(
        base_url="https://test-bridge.chorus.network",
        jwt_token="test_jwt_token"
    )
    
    # Send test envelope
    response = client.send_federation_envelope(
        envelope_data=test_envelope_bytes,
        stage_instance="test_stage_001",
        idempotency_key="test_key_123"
    )
    
    assert response.status == "accepted"
    assert "event_id" in response
```

## üìö **Additional Resources**

- **[Configuration Guide](./Configuration-Guide.md)** - API configuration options
- **[Security Guide](./Security-Guide.md)** - Security best practices
- **[Development Setup](./Development-Setup.md)** - Local development setup
- **[Troubleshooting Guide](./Troubleshooting-Guide.md)** - Common issues and solutions

---

*This API reference provides comprehensive documentation for all Chorus Bridge API endpoints and usage patterns.*
